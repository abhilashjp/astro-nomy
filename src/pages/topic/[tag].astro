---
import { getCollection } from "astro:content";
import Layout from "../../layouts/tag-layout.astro";
import { slugify } from "../../lib/utils";

export async function getStaticPaths() {
  const blogEntries = await getCollection("blog");
  const docsEntries = await getCollection("docs");
  const guidesEntries = await getCollection("guides");
  const explainedEntries = await getCollection("explained");
  const releasesEntries = await getCollection("releases");

  const allEntries = [
    ...blogEntries,
    ...docsEntries,
    ...guidesEntries,
    ...explainedEntries,
    ...releasesEntries,
  ].filter(entry => !entry.data.draft);

  const uniqueTags = [
    ...new Set(allEntries.flatMap((entry) => entry.data.tags || [])),
  ];

  return uniqueTags.map((tag) => ({
    params: { tag: slugify(tag) },
    props: {
      tag: tag, // Pass the original tag for display
      entries: allEntries.filter((entry) =>
        entry.data.tags?.includes(tag)
      ),
    },
  }));
}

const { tag } = Astro.props;
const { entries } = Astro.props;

const title = `Topic: ${tag}`;
const description = `All content related to the topic of ${tag}.`;
const url = Astro.url.href;
---

<Layout title={title} description={description}>
  <script type="application/ld+json" set:html={JSON.stringify({
    "@context": "https://schema.org",
    "@type": "CollectionPage",
    "name": title,
    "description": description,
    "url": url
  })} />
  <div class="container mx-auto px-4 py-8">
    <h1 class="text-5xl font-extrabold text-center mb-12 tracking-tight">{title}</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {entries.map((entry) => (
        <a href={`/${entry.collection}/${entry.slug}/`} class="block">
          <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 p-6 h-full flex flex-col justify-between">
            <div>
              <h2 class="text-2xl font-semibold text-gray-900 dark:text-white mb-2">
                {entry.data.title}
              </h2>
              <p class="text-gray-600 dark:text-gray-400 text-sm">
                {entry.data.description}
              </p>
            </div>
            <div class="mt-4 text-right">
              <span class="text-blue-600 hover:text-blue-700 font-medium">Read More &rarr;</span>
            </div>
          </div>
        </a>
      ))}
    </div>
  </div>
</Layout>
